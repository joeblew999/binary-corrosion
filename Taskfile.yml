# https://taskfile.dev
version: '3'

vars:
  SRC_REPO: https://github.com/joeblew999/corrosion.git
  SRC_UPSTREAM: https://github.com/superfly/corrosion.git
  SRC_DIR: .src
  BIN_DIR: .bin
  BINARY_NAME: corrosion

# Global environment for all Rust builds
env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "--cfg tokio_unstable"

includes:
  fly:
    taskfile: ./Taskfile.fly.yml
    optional: true

tasks:
  # ===========================================================================
  # Source Management (src:*)
  # ===========================================================================

  src:clone:
    desc: Clone corrosion source to .src directory
    cmds:
      - rm -rf {{.SRC_DIR}}
      - git clone {{.SRC_REPO}} {{.SRC_DIR}}
    status:
      - test -d {{.SRC_DIR}}/.git

  src:update:
    desc: Update from fork
    dir: '{{.SRC_DIR}}'
    deps: [src:clone]
    cmds:
      - git fetch origin
      - git pull origin main

  src:sync-upstream:
    desc: Sync fork with upstream superfly/corrosion
    dir: '{{.SRC_DIR}}'
    deps: [src:clone]
    cmds:
      - git remote add upstream {{.SRC_UPSTREAM}} 2>/dev/null || true
      - git fetch upstream
      - git merge upstream/main --no-edit
      - echo "Merged upstream. Review changes, then push to origin with 'git push origin main'"

  src:clean:
    desc: Remove cloned source directory
    cmds:
      - rm -rf {{.SRC_DIR}}
    status:
      - '! test -d {{.SRC_DIR}}'

  # ===========================================================================
  # Rust Setup (rust:setup:*)
  # ===========================================================================

  rust:setup:show:
    desc: Show current Rust toolchain
    cmds:
      - rustup show

  rust:setup:targets:
    desc: Install cross-compilation targets
    vars:
      TARGETS: >-
        x86_64-apple-darwin
        aarch64-apple-darwin
        x86_64-unknown-linux-gnu
        aarch64-unknown-linux-gnu
        x86_64-unknown-linux-musl
        aarch64-unknown-linux-musl
        x86_64-pc-windows-msvc
        x86_64-pc-windows-gnu
        aarch64-pc-windows-msvc
    cmds:
      - for: { var: TARGETS }
        cmd: rustup target add {{.ITEM}} || true
      - rustup target list --installed

  rust:setup:cross:
    desc: Install the cross tool for cross-compilation
    cmds:
      - cargo install cross --git https://github.com/cross-rs/cross
    status:
      - which cross

  # ===========================================================================
  # Rust Build (rust:build:*)
  # ===========================================================================

  rust:build:release:
    desc: Build for current platform (release)
    dir: '{{.SRC_DIR}}'
    deps: [src:clone]
    sources:
      - '{{.SRC_DIR}}/Cargo.toml'
      - '{{.SRC_DIR}}/Cargo.lock'
      - '{{.SRC_DIR}}/crates/**/*.rs'
    generates:
      - '{{.BIN_DIR}}/{{.BINARY_NAME}}'
    cmds:
      - cargo build --release
      - mkdir -p ../{{.BIN_DIR}}
      - cp target/release/{{.BINARY_NAME}} ../{{.BIN_DIR}}/

  rust:build:debug:
    desc: Build for current platform (debug)
    dir: '{{.SRC_DIR}}'
    deps: [src:clone]
    sources:
      - '{{.SRC_DIR}}/Cargo.toml'
      - '{{.SRC_DIR}}/Cargo.lock'
      - '{{.SRC_DIR}}/crates/**/*.rs'
    generates:
      - '{{.BIN_DIR}}/{{.BINARY_NAME}}-debug'
    cmds:
      - cargo build
      - mkdir -p ../{{.BIN_DIR}}
      - cp target/debug/{{.BINARY_NAME}} ../{{.BIN_DIR}}/{{.BINARY_NAME}}-debug

  rust:build:all:
    desc: Build for all platforms
    cmds:
      - task: rust:build:macos:all
      - task: rust:build:linux:all
      - task: rust:build:windows:all

  rust:build:clean:
    desc: Clean Rust build artifacts
    cmds:
      - rm -rf {{.BIN_DIR}}
      - cmd: cargo clean
        dir: '{{.SRC_DIR}}'
        ignore_error: true
    status:
      - '! test -d {{.BIN_DIR}}'
      - '! test -d {{.SRC_DIR}}/target'

  # ===========================================================================
  # Rust Build macOS (rust:build:macos:*)
  # ===========================================================================

  rust:build:macos:all:
    desc: Build for both macOS architectures
    cmds:
      - task: rust:build:macos:arm64
      - task: rust:build:macos:amd64

  rust:build:macos:arm64:
    desc: Build for macOS ARM64 (Apple Silicon)
    dir: '{{.SRC_DIR}}'
    deps: [src:clone]
    sources:
      - '{{.SRC_DIR}}/Cargo.toml'
      - '{{.SRC_DIR}}/Cargo.lock'
      - '{{.SRC_DIR}}/crates/**/*.rs'
    generates:
      - '{{.BIN_DIR}}/darwin-arm64/{{.BINARY_NAME}}'
    cmds:
      - cargo build --release --target aarch64-apple-darwin
      - mkdir -p ../{{.BIN_DIR}}/darwin-arm64
      - cp target/aarch64-apple-darwin/release/{{.BINARY_NAME}} ../{{.BIN_DIR}}/darwin-arm64/

  rust:build:macos:amd64:
    desc: Build for macOS AMD64 (Intel)
    dir: '{{.SRC_DIR}}'
    deps: [src:clone]
    sources:
      - '{{.SRC_DIR}}/Cargo.toml'
      - '{{.SRC_DIR}}/Cargo.lock'
      - '{{.SRC_DIR}}/crates/**/*.rs'
    generates:
      - '{{.BIN_DIR}}/darwin-amd64/{{.BINARY_NAME}}'
    cmds:
      - cargo build --release --target x86_64-apple-darwin
      - mkdir -p ../{{.BIN_DIR}}/darwin-amd64
      - cp target/x86_64-apple-darwin/release/{{.BINARY_NAME}} ../{{.BIN_DIR}}/darwin-amd64/

  rust:build:macos:universal:
    desc: Build universal macOS binary (ARM64 + AMD64)
    deps:
      - rust:build:macos:arm64
      - rust:build:macos:amd64
    sources:
      - '{{.BIN_DIR}}/darwin-arm64/{{.BINARY_NAME}}'
      - '{{.BIN_DIR}}/darwin-amd64/{{.BINARY_NAME}}'
    generates:
      - '{{.BIN_DIR}}/darwin-universal/{{.BINARY_NAME}}'
    cmds:
      - mkdir -p {{.BIN_DIR}}/darwin-universal
      - lipo -create -output {{.BIN_DIR}}/darwin-universal/{{.BINARY_NAME}} {{.BIN_DIR}}/darwin-arm64/{{.BINARY_NAME}} {{.BIN_DIR}}/darwin-amd64/{{.BINARY_NAME}}

  # ===========================================================================
  # Rust Build Linux (rust:build:linux:*)
  # ===========================================================================

  rust:build:linux:all:
    desc: Build for Linux (amd64 + arm64)
    cmds:
      - task: rust:build:linux:amd64
      - task: rust:build:linux:arm64

  rust:build:linux:amd64:
    desc: Build for Linux AMD64
    dir: '{{.SRC_DIR}}'
    deps: [src:clone]
    sources:
      - '{{.SRC_DIR}}/Cargo.toml'
      - '{{.SRC_DIR}}/Cargo.lock'
      - '{{.SRC_DIR}}/crates/**/*.rs'
    generates:
      - '{{.BIN_DIR}}/linux-amd64/{{.BINARY_NAME}}'
    ignore_error: true
    cmds:
      - cargo build --release --target x86_64-unknown-linux-gnu
      - mkdir -p ../{{.BIN_DIR}}/linux-amd64
      - cp target/x86_64-unknown-linux-gnu/release/{{.BINARY_NAME}} ../{{.BIN_DIR}}/linux-amd64/

  rust:build:linux:arm64:
    desc: Build for Linux ARM64
    dir: '{{.SRC_DIR}}'
    deps: [src:clone]
    sources:
      - '{{.SRC_DIR}}/Cargo.toml'
      - '{{.SRC_DIR}}/Cargo.lock'
      - '{{.SRC_DIR}}/crates/**/*.rs'
    generates:
      - '{{.BIN_DIR}}/linux-arm64/{{.BINARY_NAME}}'
    ignore_error: true
    cmds:
      - cargo build --release --target aarch64-unknown-linux-gnu
      - mkdir -p ../{{.BIN_DIR}}/linux-arm64
      - cp target/aarch64-unknown-linux-gnu/release/{{.BINARY_NAME}} ../{{.BIN_DIR}}/linux-arm64/

  rust:build:linux:musl:
    desc: Build for Linux with musl (static binary)
    dir: '{{.SRC_DIR}}'
    deps: [src:clone]
    sources:
      - '{{.SRC_DIR}}/Cargo.toml'
      - '{{.SRC_DIR}}/Cargo.lock'
      - '{{.SRC_DIR}}/crates/**/*.rs'
    generates:
      - '{{.BIN_DIR}}/linux-amd64-musl/{{.BINARY_NAME}}'
    ignore_error: true
    cmds:
      - cargo build --release --target x86_64-unknown-linux-musl
      - mkdir -p ../{{.BIN_DIR}}/linux-amd64-musl
      - cp target/x86_64-unknown-linux-musl/release/{{.BINARY_NAME}} ../{{.BIN_DIR}}/linux-amd64-musl/

  # ===========================================================================
  # Rust Build Linux Cross (rust:build:linux:cross:*)
  # NOTE: Cross-compilation requires temporarily moving aside the upstream
  # .cargo/config.toml which specifies clang + mold linker (not available
  # in cross Docker containers). We move it, build, then restore it.
  # RUSTFLAGS includes --cfg tokio_unstable needed for tokio-metrics.
  # ===========================================================================

  rust:build:linux:cross:all:
    desc: Build for Linux using cross tool
    cmds:
      - task: rust:build:linux:cross:amd64
      - task: rust:build:linux:cross:arm64

  rust:build:linux:cross:amd64:
    desc: Build for Linux AMD64 using cross
    dir: '{{.SRC_DIR}}'
    deps:
      - src:clone
      - rust:setup:cross
    cmds:
      - mv .cargo/config.toml .cargo/config.toml.bak || true
      - defer: mv .cargo/config.toml.bak .cargo/config.toml || true
      - cross build --release --target x86_64-unknown-linux-gnu
      - mkdir -p ../{{.BIN_DIR}}/linux-amd64
      - cp target/x86_64-unknown-linux-gnu/release/{{.BINARY_NAME}} ../{{.BIN_DIR}}/linux-amd64/
    status:
      - test -f ../{{.BIN_DIR}}/linux-amd64/{{.BINARY_NAME}}

  rust:build:linux:cross:arm64:
    desc: Build for Linux ARM64 using cross
    dir: '{{.SRC_DIR}}'
    deps:
      - src:clone
      - rust:setup:cross
    cmds:
      - mv .cargo/config.toml .cargo/config.toml.bak || true
      - defer: mv .cargo/config.toml.bak .cargo/config.toml || true
      - cross build --release --target aarch64-unknown-linux-gnu
      - mkdir -p ../{{.BIN_DIR}}/linux-arm64
      - cp target/aarch64-unknown-linux-gnu/release/{{.BINARY_NAME}} ../{{.BIN_DIR}}/linux-arm64/
    status:
      - test -f ../{{.BIN_DIR}}/linux-arm64/{{.BINARY_NAME}}

  # ===========================================================================
  # Rust Build Windows (rust:build:windows:*)
  # NOTE: Requires Windows machine or MinGW cross-compiler
  # ===========================================================================

  rust:build:windows:native:
    desc: Build for Windows AMD64 (native, run on Windows)
    dir: '{{.SRC_DIR}}'
    deps: [src:clone]
    vars:
      # Use MSVC on Windows CI (set via CARGO_BUILD_TARGET env), otherwise GNU
      WIN_TARGET: '{{.CARGO_BUILD_TARGET | default "x86_64-pc-windows-msvc"}}'
    sources:
      - '{{.SRC_DIR}}/Cargo.toml'
      - '{{.SRC_DIR}}/Cargo.lock'
      - '{{.SRC_DIR}}/crates/**/*.rs'
    generates:
      - '{{.BIN_DIR}}/windows-amd64/{{.BINARY_NAME}}.exe'
    cmds:
      - cargo build --release --target {{.WIN_TARGET}}
      - cmd: mkdir -p ../{{.BIN_DIR}}/windows-amd64
        platforms: [linux, darwin]
      - cmd: if not exist "..\\{{.BIN_DIR}}\\windows-amd64" mkdir "..\\{{.BIN_DIR}}\\windows-amd64"
        platforms: [windows]
      - cmd: cp target/{{.WIN_TARGET}}/release/{{.BINARY_NAME}}.exe ../{{.BIN_DIR}}/windows-amd64/
        platforms: [linux, darwin]
      - cmd: copy "target\\{{.WIN_TARGET}}\\release\\{{.BINARY_NAME}}.exe" "..\\{{.BIN_DIR}}\\windows-amd64\\"
        platforms: [windows]

  rust:build:windows:arm64:
    desc: Build for Windows ARM64 (cross-compile from x64)
    dir: '{{.SRC_DIR}}'
    deps: [src:clone]
    sources:
      - '{{.SRC_DIR}}/Cargo.toml'
      - '{{.SRC_DIR}}/Cargo.lock'
      - '{{.SRC_DIR}}/crates/**/*.rs'
    generates:
      - '{{.BIN_DIR}}/windows-arm64/{{.BINARY_NAME}}.exe'
    cmds:
      - cargo build --release --target aarch64-pc-windows-msvc
      - cmd: mkdir -p ../{{.BIN_DIR}}/windows-arm64
        platforms: [linux, darwin]
      - cmd: if not exist "..\\{{.BIN_DIR}}\\windows-arm64" mkdir "..\\{{.BIN_DIR}}\\windows-arm64"
        platforms: [windows]
      - cmd: cp target/aarch64-pc-windows-msvc/release/{{.BINARY_NAME}}.exe ../{{.BIN_DIR}}/windows-arm64/
        platforms: [linux, darwin]
      - cmd: copy "target\\aarch64-pc-windows-msvc\\release\\{{.BINARY_NAME}}.exe" "..\\{{.BIN_DIR}}\\windows-arm64\\"
        platforms: [windows]

  rust:build:windows:all:
    desc: Build for all Windows architectures
    cmds:
      - task: rust:build:windows:native
      - task: rust:build:windows:arm64

  rust:build:windows:cross:
    desc: Build for Windows AMD64 using cross
    dir: '{{.SRC_DIR}}'
    deps:
      - src:clone
      - rust:setup:cross
    sources:
      - '{{.SRC_DIR}}/Cargo.toml'
      - '{{.SRC_DIR}}/Cargo.lock'
      - '{{.SRC_DIR}}/crates/**/*.rs'
    generates:
      - '{{.BIN_DIR}}/windows-amd64/{{.BINARY_NAME}}.exe'
    env:
      RUSTFLAGS: "--cfg tokio_unstable"
    cmds:
      - mv .cargo/config.toml .cargo/config.toml.bak || true
      - defer: mv .cargo/config.toml.bak .cargo/config.toml || true
      - cross build --release --target x86_64-pc-windows-gnu
      - mkdir -p ../{{.BIN_DIR}}/windows-amd64
      - cp target/x86_64-pc-windows-gnu/release/{{.BINARY_NAME}}.exe ../{{.BIN_DIR}}/windows-amd64/

  # ===========================================================================
  # Rust Quality (rust:quality:*)
  # ===========================================================================

  rust:quality:check:
    desc: Check code compiles without building
    dir: '{{.SRC_DIR}}'
    deps: [src:clone]
    cmds:
      - cargo check

  rust:quality:test:
    desc: Run tests
    dir: '{{.SRC_DIR}}'
    deps: [src:clone]
    cmds:
      - cargo test

  rust:quality:fmt:
    desc: Format code
    dir: '{{.SRC_DIR}}'
    deps: [src:clone]
    cmds:
      - cargo fmt

  rust:quality:fmt:check:
    desc: Check code formatting
    dir: '{{.SRC_DIR}}'
    deps: [src:clone]
    cmds:
      - cargo fmt --check

  rust:quality:clippy:
    desc: Run clippy linter
    dir: '{{.SRC_DIR}}'
    deps: [src:clone]
    cmds:
      - cargo clippy

  # ===========================================================================
  # Run Config (run:config:*)
  # ===========================================================================

  run:config:init:
    desc: Initialize config file with local paths
    cmds:
      - mkdir -p ./.data/schemas
      - |
        cat > ./corrosion.toml << 'EOF'
        [db]
        path = "./.data/corrosion.db"
        schema_paths = ["./.data/schemas"]

        [gossip]
        addr = "[::]:8787"
        bootstrap = []
        plaintext = true

        [api]
        addr = "127.0.0.1:8080"

        [admin]
        path = "./.data/admin.sock"

        [telemetry]
        prometheus.addr = "127.0.0.1:9090"

        [log]
        format = "json"
        EOF
    status:
      - test -f ./corrosion.toml

  run:config:edit:
    desc: Edit corrosion config file
    cmds:
      - ${EDITOR:-vi} ./corrosion.toml

  run:config:schema:
    desc: Create schemas directory with example schema
    cmds:
      - mkdir -p ./.data/schemas
      - |
        cat > ./.data/schemas/example.sql << 'EOF'
        -- Example schema for corrosion
        -- Note: CRRs require non-nullable primary keys
        CREATE TABLE IF NOT EXISTS kv (
          key TEXT NOT NULL PRIMARY KEY,
          value TEXT
        );
        EOF
    status:
      - test -f ./.data/schemas/example.sql

  # ===========================================================================
  # Run Agent (run:agent:*)
  # ===========================================================================

  run:agent:foreground:
    desc: Run corrosion in foreground
    deps: [rust:build:release]
    cmds:
      - task: run:config:init
      - '{{.BIN_DIR}}/{{.BINARY_NAME}} agent -c ./corrosion.toml'

  run:agent:debug:
    desc: Run corrosion in debug mode
    deps: [rust:build:debug]
    cmds:
      - task: run:config:init
      - '{{.BIN_DIR}}/{{.BINARY_NAME}}-debug agent -c ./corrosion.toml'

  run:agent:start:
    desc: Start corrosion in the background
    deps: [rust:build:release]
    cmds:
      - task: run:config:init
      - cmd: bash -c '{{.BIN_DIR}}/{{.BINARY_NAME}} agent -c ./corrosion.toml >> ./.data/corrosion.log 2>&1 & echo $! > ./.data/corrosion.pid'
      - sleep 1
      - cmd: bash -c 'echo "Started corrosion with PID $(cat ./.data/corrosion.pid)"'
    status:
      - test -f ./.data/corrosion.pid && kill -0 $(cat ./.data/corrosion.pid) 2>/dev/null

  run:agent:stop:
    desc: Stop corrosion background process
    silent: true
    cmds:
      - |
        if [ -f ./.data/corrosion.pid ]; then
          PID=$(cat ./.data/corrosion.pid)
          if kill -0 $PID 2>/dev/null; then
            kill $PID
            echo "Stopped corrosion (PID $PID)"
          else
            echo "Process not running"
          fi
          rm -f ./.data/corrosion.pid
        else
          echo "No PID file found"
        fi

  run:agent:restart:
    desc: Restart corrosion (stop + start)
    cmds:
      - task: run:agent:stop
      - task: run:agent:start

  run:agent:status:
    desc: Check if corrosion is running
    silent: true
    cmds:
      - |
        if [ -f ./.data/corrosion.pid ]; then
          PID=$(cat ./.data/corrosion.pid)
          if kill -0 $PID 2>/dev/null; then
            echo "Corrosion is running (PID $PID)"
          else
            echo "Corrosion is not running (stale PID file)"
          fi
        else
          echo "Corrosion is not running"
        fi

  run:agent:logs:
    desc: Tail corrosion logs
    cmds:
      - tail -f ./.data/corrosion.log

  # ===========================================================================
  # Run Info (run:info:*)
  # ===========================================================================

  run:info:help:
    desc: Show corrosion help
    deps: [rust:build:release]
    cmds:
      - '{{.BIN_DIR}}/{{.BINARY_NAME}} --help'

  run:info:version:
    desc: Show corrosion version
    deps: [rust:build:release]
    cmds:
      - '{{.BIN_DIR}}/{{.BINARY_NAME}} --version'

  # ===========================================================================
  # Run Clean (run:clean:*)
  # ===========================================================================

  run:clean:data:
    desc: Clean runtime data (db, logs, pid)
    cmds:
      - task: run:agent:stop
      - rm -rf ./.data
      - echo "Cleaned runtime data"

  run:clean:config:
    desc: Clean config file
    cmds:
      - rm -f ./corrosion.toml
      - echo "Cleaned config"

  run:clean:all:
    desc: Clean all runtime data and config
    cmds:
      - task: run:agent:stop
      - rm -rf ./.data
      - rm -f ./corrosion.toml
      - echo "Cleaned all runtime data and config"

  # ===========================================================================
  # Deploy Fly.io (deploy:fly:*)
  # ===========================================================================
  #
  # These tasks wrap fly:* tasks with our deploy config.
  # Uses --config to point fly at deploy/fly/fly.toml
  #
  # First time setup:
  #   task deploy:fly:setup
  #
  # Deploy:
  #   task deploy:fly:deploy

  deploy:fly:setup:
    desc: First time Fly.io setup (create app + volume, idempotent)
    vars:
      FLY_APP: '{{.FLY_APP | default "corrosion-demo"}}'
      FLY_REGION: '{{.FLY_REGION | default "syd"}}'
    cmds:
      # Create app (idempotent - ignores error if exists)
      - task: fly:apps:create
        vars:
          APP_NAME: '{{.FLY_APP}}'
        ignore_error: true
      # Create volume if not exists (check with volumes:list first)
      - |
        if ! task fly:volumes:list FLY_APP={{.FLY_APP}} 2>/dev/null | grep -q corro_data; then
          task fly:volumes:create VOL_NAME=corro_data FLY_APP={{.FLY_APP}} FLY_REGION={{.FLY_REGION}}
        fi

  deploy:fly:deploy:
    desc: Deploy to Fly.io (run rust:build:linux:cross:amd64 first if binary doesn't exist)
    preconditions:
      - sh: test -f {{.BIN_DIR}}/linux-amd64/{{.BINARY_NAME}}
        msg: "Linux AMD64 binary not found. Run: task rust:build:linux:cross:amd64"
    cmds:
      - task: fly:app:deploy
        vars:
          FLY_CONFIG: deploy/fly/fly.toml
          FLY_DOCKERFILE: deploy/fly/Dockerfile

  deploy:fly:status:
    desc: Show Fly.io app status
    cmds:
      - task: fly:app:status
        vars:
          FLY_CONFIG: deploy/fly/fly.toml

  deploy:fly:logs:
    desc: Tail Fly.io app logs
    cmds:
      - task: fly:app:logs
        vars:
          FLY_CONFIG: deploy/fly/fly.toml

  deploy:fly:ssh:
    desc: SSH into Fly.io app
    cmds:
      - task: fly:app:ssh
        vars:
          FLY_CONFIG: deploy/fly/fly.toml

  deploy:fly:scale:
    desc: Scale to multiple nodes (set COUNT=n)
    cmds:
      - task: fly:platform:scale-count
        vars:
          FLY_CONFIG: deploy/fly/fly.toml
          COUNT: '{{.COUNT | default "1"}}'

  deploy:fly:destroy:
    desc: Destroy Fly.io app (DANGEROUS)
    cmds:
      - task: fly:apps:destroy
        vars:
          FLY_APP: '{{.FLY_APP | default "corrosion-demo"}}'
